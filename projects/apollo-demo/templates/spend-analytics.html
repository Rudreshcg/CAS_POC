<!DOCTYPE html>
<html>
<head>
    <title>Spend Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Chart.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .back-home-btn {
            background-color: var(--primary-orange);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            transition: all 0.3s ease;
            margin: 1rem 2rem;
        }

        .back-home-btn:hover {
            background-color: #e67e1c;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .material-header {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary-orange);
        }

        .material-header h2 {
            color: var(--secondary-dark);
            margin-bottom: 0.5rem;
        }

        .material-header p {
            color: var(--primary-gray);
            font-size: 0.9rem;
        }

        body {
            font-family: Arial, sans-serif;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body {
            padding: 20px;
            background-color: var(--secondary-light);
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .filter-box {
            padding: 10px;
            border: 1px solid var(--secondary-light);
            border-radius: 5px;
        }

        .filter-box select {
            width: 100%;
            padding: 8px;
            border: none;
            background-color: var(--primary-orange);
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }

        .filter-box select:hover {
            background-color: #e87d18;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-wrapper {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--secondary-light);
            min-height: 300px;
        }

        /* Add CSS variables */
        :root {
            --primary-green: #A0BF3F;
            --primary-orange: #FA8E29;
            --primary-gray: #6E7E85;
            --secondary-light: #CBD2D9;
            --secondary-dark: #333F48;
            --secondary-blue: #7DA2BA;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1>Apollo</h1>
        </div>
        <div class="header-center">
            <!-- Center section empty but maintained for layout -->
        </div>
        <div class="header-right">
            <button><i class="fas fa-bell"></i></button>
            <div class="user-info">
                <div class="user-avatar">JD</div>
                <span>John Doe</span>
            </div>
            <button><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <a href="{{ url_for('index') }}" class="back-home-btn">
        <i class="fas fa-home"></i>
        Back Home
    </a>

    <div class="container">
      {% if material %}
      <div class="material-header">
          <h2>Spend Analytics for: {{ material }}</h2>
          <div class="dashboard">
            <div class="filters">
                <div class="filter-box">
                    <select id="buyerName">
                        <option value="John">John</option>
                    </select>
                </div>
                <div class="filter-box">
                    <select id="year">
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-wrapper">
                    <canvas id="quantityChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="valueChart"></canvas>
                </div>
            </div>

            <div class="chart-wrapper">
                <canvas id="timelineChart"></canvas>
            </div>
          </div>
      </div>
      {% else %}
      <div class="material-header">
          <h2>No material selected</h2>
          <p>Please select a material from the dashboard search.</p>
      </div>
      {% endif %}
    </div>

    <script>
        // Function to normalize material names
        function normalizeMaterialName(name) {
            return name.toLowerCase().trim().replace(/\s+/g, '_');
        }

        // Get and normalize the material name from Flask
        const rawMaterial = {{ material|tojson|safe }};
        const selectedMaterial = normalizeMaterialName(rawMaterial);
        console.log("Normalized selected material:", selectedMaterial);

        // Normalize the chart data keys
        const originalChartData = {
            'Acetic acid': {
                quantity: {
                    labels: ['Indonesia', 'Malaysia', 'Thailand'],
                    data: [47.393, 7.215, 1.045]
                },
                value: {
                    labels: ['Indonesia', 'Malaysia', 'Thailand'],
                    data: [28.35, 5.55, 0.71]
                },
                timeline: {
                    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November'],
                    values: [6.052, 4.807, 5.081, 4.575, 4.500, 5.228, 6.821, 5.393, 1.099, 5.032, 7.481],
                    quantity: [3.4, 2.7, 2.9, 2.8, 2.7, 3.4, 4.3, 3.5, 0.8, 3.4, 5.1]
                }
            },
            'Carbon black': {
                quantity: {
                    labels: ['China', 'Thailand', 'Korea'],
                    data: [35.2, 12.8, 8.5]
                },
                value: {
                    labels: ['China', 'Thailand', 'Korea'],
                    data: [22.5, 8.2, 5.4]
                },
                timeline: {
                    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November'],
                    values: [4.2, 3.8, 4.5, 5.1, 4.8, 5.5, 5.8, 4.9, 3.2, 4.7, 5.9],
                    quantity: [2.8, 2.5, 3.0, 3.4, 3.2, 3.7, 3.9, 3.3, 2.1, 3.1, 3.9]
                }
            },
            'Glycerine': {
                quantity: {
                    labels: ['Malaysia', 'Indonesia', 'Philippines'],
                    data: [28.6, 15.4, 10.2]
                },
                value: {
                    labels: ['Malaysia', 'Indonesia', 'Philippines'],
                    data: [18.3, 9.8, 6.5]
                },
                timeline: {
                    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November'],
                    values: [3.8, 4.2, 4.6, 4.1, 4.4, 4.9, 5.2, 4.5, 3.8, 4.3, 5.1],
                    quantity: [2.5, 2.8, 3.1, 2.7, 2.9, 3.3, 3.5, 3.0, 2.5, 2.9, 3.4]
                }
            }
        };

        // Create normalized version of the chart data
        const chartData = {};
        Object.entries(originalChartData).forEach(([key, value]) => {
            const normalizedKey = normalizeMaterialName(key);
            chartData[normalizedKey] = value;
        });

        console.log("Available materials:", Object.keys(chartData));

        let quantityChart, valueChart, timelineChart;

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function initializeCharts() {
            try {
                // Check if material exists in our normalized data
                if (!chartData[selectedMaterial]) {
                    throw new Error(`No data available for material: ${rawMaterial} (normalized: ${selectedMaterial}). Available materials: ${Object.keys(chartData).join(', ')}`);
                }

                const chartColors = [
                    getComputedStyle(document.documentElement).getPropertyValue('--primary-green').trim(),
                    getComputedStyle(document.documentElement).getPropertyValue('--primary-orange').trim(),
                    getComputedStyle(document.documentElement).getPropertyValue('--secondary-blue').trim()
                ];

                quantityChart = new Chart(document.getElementById('quantityChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: chartColors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Total Quantity of Imports from different Countries',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark')
                            },
                            legend: {
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark')
                                }
                            }
                        }
                    }
                });

                valueChart = new Chart(document.getElementById('valueChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: chartColors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Total Value of Imports from different Countries',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark')
                            },
                            legend: {
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark')
                                }
                            }
                        }
                    }
                });

                timelineChart = new Chart(document.getElementById('timelineChart'), {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Total Value',
                            data: [],
                            backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-green'),
                            order: 2
                        }, {
                            label: 'Quantity (MT)',
                            data: [],
                            type: 'line',
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--secondary-blue'),
                            borderWidth: 2,
                            fill: false,
                            order: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Total Value and Quantity (MT) by Year and Month',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark')
                            },
                            legend: {
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark')
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark')
                                }
                            },
                            x: {
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark')
                                }
                            }
                        }
                    }
                });

                // Update charts with initial data
                updateCharts(selectedMaterial);
            } catch (error) {
                console.error('Error initializing charts:', error);
                showError(error.message);
            }
        }

        function updateCharts(material) {
            try {
                const data = chartData[material];
                if (!data) {
                    throw new Error(`No data found for ${material}`);
                }

                console.log('Updating charts with data:', data);

                quantityChart.data.labels = data.quantity.labels;
                quantityChart.data.datasets[0].data = data.quantity.data;
                quantityChart.update();

                valueChart.data.labels = data.value.labels;
                valueChart.data.datasets[0].data = data.value.data;
                valueChart.update();

                timelineChart.data.labels = data.timeline.labels;
                timelineChart.data.datasets[0].data = data.timeline.values;
                timelineChart.data.datasets[1].data = data.timeline.quantity;
                timelineChart.update();
            } catch (error) {
                console.error('Error updating charts:', error);
                showError(error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart === 'undefined') {
                showError('Chart.js failed to load. Please refresh the page.');
                return;
            }
            initializeCharts();
        });
    </script>
</body>
<footer>
    <p>Â© 2025 SCMmax. All rights reserved.</p>
</footer>
</html>